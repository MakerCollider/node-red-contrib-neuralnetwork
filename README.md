# node-red-contrib-neuralnetwork


# Install

```bash

Download node-red-contrib-neuralnetwork to nodered root directory. 
Windows for example: C:\node-red\node_modules
Linux for example: /home/root/node-red/node_modules

```

**You will need to restart Node-RED for it to pick-up the new nodes.**

# Usage

node-red-contrib-neuralnetwork is based on [brain](https://github.com/harthur/brain). You need to see it basic usage at first.

## Train

When there is no `msg.netData` input, `brain` node will train with `msg.trainData` and output `net.toJSON` in `msg.payload`.

## Run

When there is `msg.netData` input, `brain` node will not train anymore. Instead, it will directory run `net.run()` with your `msg.runData`. And output the result in `msg.payload`.

# Example

## Train:
Function

```json
[{"id":"ff50be62.40998","type":"inject","z":"496f001a.0cd7f","name":"train","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":143.8958282470703,"y":407.8888854980469,"wires":[["ae34349.ba5bfc8"]]},{"id":"ae34349.ba5bfc8","type":"function","z":"496f001a.0cd7f","name":"traindata","func":"// This function return a fake json array\nvar trainData = [{input: { r: 0.03, g: 0.7, b: 0.5 }, output: { black: 1 }},\n           {input: { r: 0.16, g: 0.09, b: 0.2 }, output: { white: 1 }},\n           {input: { r: 0.5, g: 0.5, b: 1.0 }, output: { white: 1 }}];\n\nmsg.trainData = trainData;\nreturn msg;","outputs":1,"noerr":0,"x":284.8957977294922,"y":406.8888854980469,"wires":[["c0201ae5.864698"]]},{"id":"c0201ae5.864698","type":"neuralNetwork","z":"496f001a.0cd7f","name":"neuralNetwork","brainType":"train","learningRate":0.3,"hiddenLayers":"3,4","errorThresh":0.005,"iterations":20000,"logPeriod":10,"x":486.72911071777344,"y":403.72222900390625,"wires":[["7f0548cb.3a53d8"]]},{"id":"7f0548cb.3a53d8","type":"debug","z":"496f001a.0cd7f","name":"","active":true,"console":"false","complete":"payload","x":688.8957977294922,"y":399.8888854980469,"wires":[]}]
```
File

```json
[{"id":"6dfd57c7.97c488","type":"file","z":"5f229c05.6151c4","name":"","filename":"netdata","appendNewline":true,"createDir":true,"overwriteFile":"true","x":688.8402557373047,"y":90.96530151367188,"wires":[]},{"id":"f0b9653f.3c7498","type":"neuralNetwork","z":"5f229c05.6151c4","name":"neuralNetwork","brainType":"train","learningRate":0.3,"hiddenLayers":"3,4","errorThresh":0.005,"iterations":20000,"logPeriod":10,"x":466.8332977294922,"y":93.72222900390625,"wires":[["6dfd57c7.97c488"]]},{"id":"f726b678.8370e8","type":"function","z":"5f229c05.6151c4","name":"traindata","func":"// This function return a fake json array\nvar trainData = [{input: { r: 0.03, g: 0.7, b: 0.5 }, output: { black: 1 }},\n           {input: { r: 0.16, g: 0.09, b: 0.2 }, output: { white: 1 }},\n           {input: { r: 0.5, g: 0.5, b: 1.0 }, output: { white: 1 }}];\n\nmsg.trainData = trainData;\nreturn msg;","outputs":1,"noerr":0,"x":273.99993896484375,"y":98.88888549804688,"wires":[["f0b9653f.3c7498"]]},{"id":"1bcaffdc.bb291","type":"inject","z":"5f229c05.6151c4","name":"train","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":122,"y":104.88888549804688,"wires":[["f726b678.8370e8"]]}]
```
Sensor

```json
[{"id":"e1780229.6b47b","type":"inject","z":"b7a25b79.f3dff8","name":"train","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":206.3332977294922,"y":716.38330078125,"wires":[["64a655bb.97a61c"]]},{"id":"64a655bb.97a61c","type":"file in","z":"b7a25b79.f3dff8","name":"read traindata","filename":"/home/root/node-red/car_train_data","format":"utf8","x":413.3332977294922,"y":705.3832778930664,"wires":[["a5340653.4413b8"]]},{"id":"a5340653.4413b8","type":"neuralNetwork","z":"b7a25b79.f3dff8","name":"neuralNetwork","brainType":"train","learningRate":0.3,"hiddenLayers":"3,4","errorThresh":0.005,"iterations":20000,"logPeriod":10,"x":629.5148315429688,"y":707.5406875610352,"wires":[["24440cbb.708c94"]]},{"id":"24440cbb.708c94","type":"file","z":"b7a25b79.f3dff8","name":"read netdata","filename":"/home/root/node-red/car_net_data","appendNewline":false,"createDir":true,"overwriteFile":"true","x":848.3333435058594,"y":710.3832321166992,"wires":[]}]
```

## Run:
Function

```json
[{"id":"8cee087a.8122c8","type":"neuralNetwork","z":"496f001a.0cd7f","name":"neuralNetwork","brainType":"run","learningRate":0.3,"hiddenLayers":"3,4","errorThresh":0.005,"iterations":20000,"logPeriod":10,"x":528.8957366943359,"y":251.88888549804688,"wires":[["e8aac9ac.195888"]]},{"id":"bfcdf274.76beb","type":"function","z":"496f001a.0cd7f","name":"rundata & netdata","func":"// This function return a fake json array\nvar netData = {\"layers\":[{\"b\":{},\"g\":{},\"r\":{}},{\"0\":{\"bias\":-0.9607698911892122,\"weights\":{\"b\":-0.8241525249603725,\"g\":3.537892108679892,\"r\":-2.716488101274963}},\"1\":{\"bias\":-1.1516024332750348,\"weights\":{\"b\":-1.0126001075152462,\"g\":4.353715735686107,\"r\":-3.2233345935870257}},\"2\":{\"bias\":0.4888619188275802,\"weights\":{\"b\":0.41953281378406115,\"g\":-0.9601032184316537,\"r\":0.7482923208072509}}},{\"0\":{\"bias\":1.3094754653086798,\"weights\":{\"0\":-2.600636916847057,\"1\":-3.396884376808377,\"2\":1.487054322123148}},\"1\":{\"bias\":0.5312262343955613,\"weights\":{\"0\":-1.9723085220356809,\"1\":-2.1034572097575244,\"2\":0.7000633911919903}},\"2\":{\"bias\":1.0872088028804758,\"weights\":{\"0\":-2.276035491011995,\"1\":-2.9679744880891796,\"2\":1.1001576381403693}},\"3\":{\"bias\":0.15821536225567093,\"weights\":{\"0\":-1.4435204625392943,\"1\":-2.09799352420935,\"2\":0.658272707668071}}},{\"white\":{\"bias\":-2.9740426876751234,\"weights\":{\"0\":3.0932096393643187,\"1\":1.7436477393563405,\"2\":2.7758308414721604,\"3\":1.5272730436751654}},\"black\":{\"bias\":3.005161280623962,\"weights\":{\"0\":-3.2448772390674048,\"1\":-1.9132040734678886,\"2\":-2.4921726882588526,\"3\":-1.6120206348469082}}}],\"outputLookup\":true,\"inputLookup\":true};\nvar runData = { r: 1, g: 0.4, b: 0 };\n\nmsg.runData = runData;\nmsg.netData = netData;\nreturn msg;","outputs":1,"noerr":0,"x":306.8957824707031,"y":252.88888549804688,"wires":[["8cee087a.8122c8"]]},{"id":"773a5a72.0c89d4","type":"inject","z":"496f001a.0cd7f","name":"run","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":131.8958282470703,"y":253.88888549804688,"wires":[["bfcdf274.76beb"]]},{"id":"e8aac9ac.195888","type":"debug","z":"496f001a.0cd7f","name":"","active":true,"console":"false","complete":"payload","x":720.8957977294922,"y":255.88888549804688,"wires":[]}]
```
File

```json
[{"id":"37cbc9fd.166896","type":"inject","z":"5f229c05.6151c4","name":"run","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":85,"y":356.8888854980469,"wires":[["8e418104.7c2e9"]]},{"id":"8e418104.7c2e9","type":"function","z":"5f229c05.6151c4","name":"rundata","func":"// This function return a fake json array\nvar runData = { r: 1, g: 0.4, b: 0 };\n\nmsg.runData = runData;\nreturn msg;","outputs":1,"noerr":0,"x":232.89578247070312,"y":346.8888854980469,"wires":[["26c2bea8.b20812"]]},{"id":"26c2bea8.b20812","type":"file in","z":"5f229c05.6151c4","name":"","filename":"netdata","format":"utf8","x":347.8260955810547,"y":410.763916015625,"wires":[["8f45195a.bce758"]]},{"id":"8f45195a.bce758","type":"change","z":"5f229c05.6151c4","name":"msg.netData","rules":[{"t":"set","p":"netData","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":520.8368377685547,"y":404.7361145019531,"wires":[["f307ca1e.f31d78"]]},{"id":"f307ca1e.f31d78","type":"neuralNetwork","z":"5f229c05.6151c4","name":"neuralNetwork","brainType":"run","learningRate":0.3,"hiddenLayers":"3,4","errorThresh":0.005,"iterations":20000,"logPeriod":10,"x":656.9999237060547,"y":331.8888854980469,"wires":[["ae0e7f3c.4df51"]]},{"id":"ae0e7f3c.4df51","type":"debug","z":"5f229c05.6151c4","name":"","active":true,"console":"false","complete":"payload","x":807.9999847412109,"y":282.8888854980469,"wires":[]}]
```
Sensor

```json
[{"id":"ad5308eb.85a8a8","type":"Driver","z":"b7a25b79.f3dff8","name":"Driver","lpwm":6,"ldir":7,"rpwm":5,"rdir":4,"speed":"40","timeout":"0.5","x":1023.9999694824219,"y":151.04999542236328,"wires":[[]]},{"id":"f89b3f76.db198","type":"inject","z":"b7a25b79.f3dff8","name":"前","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":198.99996948242188,"y":86.04998779296875,"wires":[["9aa675f0.0d7798"]]},{"id":"c7aa5e9f.2457c","type":"inject","z":"b7a25b79.f3dff8","name":"后","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":195.99996948242188,"y":125.04998779296875,"wires":[["65b69508.a6c08c"]]},{"id":"8a67071b.e7e938","type":"inject","z":"b7a25b79.f3dff8","name":"左","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":196.99996948242188,"y":163.04998779296875,"wires":[["e430bff6.a31eb"]]},{"id":"93956947.6db968","type":"inject","z":"b7a25b79.f3dff8","name":"右","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":196.99996948242188,"y":199.04998779296875,"wires":[["28a166a.543e89a"]]},{"id":"9aa675f0.0d7798","type":"change","z":"b7a25b79.f3dff8","name":"forwards","rules":[{"t":"set","p":"forwards","to":"1"}],"action":"","property":"","from":"","to":"","reg":false,"x":339.9999542236328,"y":87.04998016357422,"wires":[["ad47ad62.f4722","f58d8075.64678"]]},{"id":"65b69508.a6c08c","type":"change","z":"b7a25b79.f3dff8","name":"backwards","rules":[{"t":"set","p":"backwards","to":"1"}],"action":"","property":"","from":"","to":"","reg":false,"x":346.9999542236328,"y":125.04998779296875,"wires":[["ad47ad62.f4722","98ac4e09.96b79"]]},{"id":"e430bff6.a31eb","type":"change","z":"b7a25b79.f3dff8","name":"leftwards","rules":[{"t":"set","p":"leftwards","to":"1"}],"action":"","property":"","from":"","to":"","reg":false,"x":340,"y":163.04998779296875,"wires":[["ad47ad62.f4722","de52cb8d.801248"]]},{"id":"28a166a.543e89a","type":"change","z":"b7a25b79.f3dff8","name":"rightwards","rules":[{"t":"set","p":"rightwards","to":"1"}],"action":"","property":"","from":"","to":"","reg":false,"x":341.9999694824219,"y":199.04998779296875,"wires":[["ad47ad62.f4722","2a0570b5.d8603"]]},{"id":"1b512821.8e8808","type":"mraa-gpio-ain","z":"b7a25b79.f3dff8","name":"","pin":"0","interval":"1000","x":176,"y":327.04998779296875,"wires":[["250d185a.f094a8"]]},{"id":"dd446ae8.e91b08","type":"mraa-gpio-ain","z":"b7a25b79.f3dff8","name":"","pin":"1","interval":"1000","x":178,"y":372.04998779296875,"wires":[["d4e9c82b.0558e8"]]},{"id":"b24af55f.d48088","type":"mraa-gpio-ain","z":"b7a25b79.f3dff8","name":"","pin":"2","interval":"1000","x":175,"y":419.04998779296875,"wires":[["d6573808.a835d8"]]},{"id":"843859ae.f7e048","type":"mraa-gpio-ain","z":"b7a25b79.f3dff8","name":"","pin":"3","interval":"1000","x":178,"y":460.04998779296875,"wires":[["113efc60.aa7774"]]},{"id":"250d185a.f094a8","type":"change","z":"b7a25b79.f3dff8","name":"前方距离","rules":[{"t":"set","p":"front","to":"msg.payload"}],"action":"","property":"","from":"","to":"","reg":false,"x":326.3333282470703,"y":328.38330078125,"wires":[["ad47ad62.f4722","15a2c88f.83da87"]]},{"id":"d4e9c82b.0558e8","type":"change","z":"b7a25b79.f3dff8","name":"右侧距离","rules":[{"t":"set","p":"right","to":"msg.payload"}],"action":"","property":"","from":"","to":"","reg":false,"x":327.33331298828125,"y":370.38330078125,"wires":[["ad47ad62.f4722","15a2c88f.83da87"]]},{"id":"d6573808.a835d8","type":"change","z":"b7a25b79.f3dff8","name":"后方距离","rules":[{"t":"set","p":"back","to":"msg.payload"}],"action":"","property":"","from":"","to":"","reg":false,"x":328.33331298828125,"y":412.38330078125,"wires":[["ad47ad62.f4722","15a2c88f.83da87"]]},{"id":"113efc60.aa7774","type":"change","z":"b7a25b79.f3dff8","name":"左侧距离","rules":[{"t":"set","p":"left","to":"msg.payload"}],"action":"","property":"","from":"","to":"","reg":false,"x":329.33331298828125,"y":458.38330078125,"wires":[["ad47ad62.f4722","15a2c88f.83da87"]]},{"id":"39f1cc48.bc2d44","type":"file","z":"b7a25b79.f3dff8","name":"save traindata","filename":"/home/root/node-red/car_train_data","appendNewline":false,"createDir":true,"overwriteFile":"true","x":866.3331756591797,"y":284.38329315185547,"wires":[]},{"id":"7698689f.328e08","type":"inject","z":"b7a25b79.f3dff8","name":"保存","topic":"","payload":"send","payloadType":"string","repeat":"","crontab":"","once":false,"x":191.33331298828125,"y":248.38333129882812,"wires":[["8ce017a.4d32de8"]]},{"id":"8ce017a.4d32de8","type":"change","z":"b7a25b79.f3dff8","name":"send","rules":[{"t":"set","p":"send","to":"msg.payload"}],"action":"","property":"","from":"","to":"","reg":false,"x":334.3332824707031,"y":248.38331604003906,"wires":[["ad47ad62.f4722"]]},{"id":"565aa210.53584c","type":"inject","z":"b7a25b79.f3dff8","name":"run","topic":"","payload":"","payloadType":"string","repeat":"","crontab":"","once":true,"x":198.33334350585938,"y":594.38330078125,"wires":[["cbd32d2.ea91ad"]]},{"id":"cbd32d2.ea91ad","type":"file in","z":"b7a25b79.f3dff8","name":"read netdata","filename":"/home/root/node-red/car_net_data","format":"utf8","x":395.33326721191406,"y":592.38330078125,"wires":[["2eeb4156.5fe60e"]]},{"id":"ad47ad62.f4722","type":"dataCollect","z":"b7a25b79.f3dff8","name":"train data collect","inRules":[{"name":"front"},{"name":"back"},{"name":"left"},{"name":"right"}],"outRules":[{"name":"forwards"},{"name":"backwards"},{"name":"leftwards"},{"name":"rightwards"}],"sendCmd":"send","inGroupNumber":"3","outGroupNumber":1,"prev_inGroupNumber":"3","prev_outGroupNumber":1,"x":612.3832550048828,"y":286.0499801635742,"wires":[["39f1cc48.bc2d44"]]},{"id":"f58d8075.64678","type":"change","z":"b7a25b79.f3dff8","name":"0","rules":[{"t":"set","p":"direction","to":"0"}],"action":"","property":"","from":"","to":"","reg":false,"x":590.3833160400391,"y":84,"wires":[["ad5308eb.85a8a8"]]},{"id":"98ac4e09.96b79","type":"change","z":"b7a25b79.f3dff8","name":"1","rules":[{"t":"set","p":"direction","to":"1"}],"action":"","property":"","from":"","to":"","reg":false,"x":587.3833160400391,"y":125.05000305175781,"wires":[["ad5308eb.85a8a8"]]},{"id":"de52cb8d.801248","type":"change","z":"b7a25b79.f3dff8","name":"2","rules":[{"t":"set","p":"direction","to":"2"}],"action":"","property":"","from":"","to":"","reg":false,"x":590.3833160400391,"y":164.0500030517578,"wires":[["ad5308eb.85a8a8"]]},{"id":"2a0570b5.d8603","type":"change","z":"b7a25b79.f3dff8","name":"3","rules":[{"t":"set","p":"direction","to":"3"}],"action":"","property":"","from":"","to":"","reg":false,"x":594.3833160400391,"y":209.0500030517578,"wires":[["ad5308eb.85a8a8"]]},{"id":"15a2c88f.83da87","type":"multiInData","z":"b7a25b79.f3dff8","name":" run data","rules":[{"name":"front"},{"name":"back"},{"name":"left"},{"name":"right"}],"x":614.2164306640625,"y":383.88329315185547,"wires":[["4520e3be.7c271c"]]},{"id":"47712b81.8c6b44","type":"outputJudge","z":"b7a25b79.f3dff8","name":"outdata judge","rules":[{"name":"forwards","value":"0"},{"name":"backwards","value":"1"},{"name":"rightwards","value":"2"},{"name":"leftwards","value":"3"}],"judgeType":"1","resultValue":"direction","x":1075.216552734375,"y":452.88333892822266,"wires":[["ad5308eb.85a8a8"]]},{"id":"2eeb4156.5fe60e","type":"change","z":"b7a25b79.f3dff8","name":"msg.netData","rules":[{"t":"set","p":"netData","to":"msg.payload"}],"action":"","property":"","from":"","to":"","reg":false,"x":632.3996276855469,"y":586.8500900268555,"wires":[["e7285f1c.2e7ed"]]},{"id":"e7285f1c.2e7ed","type":"neuralNetwork","z":"b7a25b79.f3dff8","name":"neuralNetwork","brainType":"run","learningRate":0.3,"hiddenLayers":"3,4","errorThresh":0.005,"iterations":20000,"logPeriod":10,"x":962.5148315429688,"y":574.5406265258789,"wires":[["47712b81.8c6b44"]]},{"id":"4520e3be.7c271c","type":"change","z":"b7a25b79.f3dff8","name":"msg.runData","rules":[{"t":"set","p":"runData","to":"msg.payload"}],"action":"","property":"","from":"","to":"","reg":false,"x":843.2165222167969,"y":405.38329315185547,"wires":[["e7285f1c.2e7ed"]]}]
```
# License 

MIT License
\ No newline at end of file